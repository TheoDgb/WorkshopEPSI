<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Workshop EPSI</title>
    <!--INCLURE BOOTSTRAP & PLOTLY-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">WorkShop EPSI</a>
        </div>
    </nav>
    <br>
    <div class="d-flex justify-content-center">
        <button id="startButton" class="btn btn-primary">Start</button>
    </div>
    <br><br>
    <div class="container">
        <div class="row">
            <div class="col-8">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
            </div>
            <div class="col-4" id="graphe">
                <div id="graph"></div>
                <div id="classification"></div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    // Get the start button element
    const startButton = document.getElementById('startButton');

    // Attach the click event listener
    startButton.addEventListener('click', function() {
        startButton.disabled = true;
        startButton.classList.remove('btn-primary');
        startButton.classList.add('btn-secondary');

        // Démarrer le jeu
        gameLoop();
    });






    // Variables de stockage
    let xData = [];
    let yData = [];
    let intervalID = null;
    let startTime = null;

    // // Fonction pour simuler la pression artérielle (systolique et diastolique)
    // function generateBloodPressure(t) {
    //     const baseSystolic = 120; // Valeur systolique de base
    //     const baseDiastolic = 80; // Valeur diastolique de base
    //     const systolicFluctuation = (Math.random() - 0.5) * 10; // Fluctuation pour systolique
    //     const diastolicFluctuation = (Math.random() - 0.5) * 5; // Fluctuation pour diastolique
    //
    //     // Simuler les pics de stress : augmentation rapide de la pression
    //     const stressSpike = Math.random() > 0.98 ? Math.random() * 20 : 0; // Pic de stress
    //     const systolic = baseSystolic + systolicFluctuation + stressSpike; // Pression systolique
    //     const diastolic = baseDiastolic + diastolicFluctuation; // Pression diastolique
    //
    //     return { systolic: systolic, diastolic: diastolic };
    // }



    /*
    // Variables pour suivre le pic et la durée
    let currentSystolic = null;
    let currentDiastolic = null;
    let peakDuration = 0; // Durée restante du pic

    // Fonction pour simuler la pression artérielle (systolique et diastolique)
    function generateBloodPressure(t) {
        const baseSystolic = 120; // Valeur systolique de base
        const baseDiastolic = 80;  // Valeur diastolique de base

        // Vérifier si un pic est actif
        if (peakDuration > 0) {
            // On est en période de pic, oscillation autour de la pression actuelle
            const systolicFluctuation = (Math.random() - 0.5) * 10; // Fluctuation modérée autour du pic
            const diastolicFluctuation = (Math.random() - 0.5) * 5; // Fluctuation modérée autour du pic
            const systolic = currentSystolic + systolicFluctuation; // Pression systolique
            const diastolic = currentDiastolic + diastolicFluctuation; // Pression diastolique

            // Décrémenter la durée restante du pic
            peakDuration -= 0.1; // Étant donné que cette fonction est appelée toutes les 100 ms (0.1 s)

            return { systolic: Math.min(Math.max(systolic, 90), 200), diastolic: Math.min(Math.max(diastolic, 60), 120) };
        } else {
            // Pas de pic actif, générer normalement
            const systolicFluctuation = (Math.random() - 0.5) * 10; // Fluctuation modérée pour systolique
            const diastolicFluctuation = (Math.random() - 0.5) * 5; // Fluctuation modérée pour diastolique

            // Simuler des pics de stress : augmentation rapide de la pression
            if (Math.random() > 0.95) { // Pic de stress, très rare (5%)
                const stressSpike = Math.random() * 40; // Valeur de pic
                currentSystolic = baseSystolic + systolicFluctuation + stressSpike; // Mémoriser la valeur du pic
                currentDiastolic = baseDiastolic + diastolicFluctuation; // Mémoriser la valeur diastolique
                peakDuration = Math.random() * 4 + 1; // Durée de 3 à 8 secondes
            } else {
                currentSystolic = baseSystolic + systolicFluctuation; // Pas de pic, juste fluctuation normale
                currentDiastolic = baseDiastolic + diastolicFluctuation; // Pas de pic, juste fluctuation normale
            }

            // Ajustement pour garder les valeurs dans des limites physiologiques
            const adjustedSystolic = Math.min(Math.max(currentSystolic, 90), 200); // Limites pour systolique
            const adjustedDiastolic = Math.min(Math.max(currentDiastolic, 60), 120); // Limites pour diastolique

            return { systolic: adjustedSystolic, diastolic: adjustedDiastolic };
        }
    }*/

    // Variables pour suivre le pic et la durée
    let currentSystolic = null;
    let currentDiastolic = null;
    let peakDuration = 0; // Durée restante du pic

    // Fonction pour simuler la pression artérielle (systolique et diastolique)
    function generateBloodPressure(t) {
        const baseSystolic = 120; // Valeur systolique de base
        const baseDiastolic = 80;  // Valeur diastolique de base

        // Vérifier si un pic est actif
        if (peakDuration > 0) {
            // On est en période de pic, oscillation autour de la pression actuelle (systolique et diastolique)
            const systolicFluctuation = (Math.random() - 0.5) * 10; // Fluctuation modérée autour du pic systolique
            const diastolicFluctuation = (Math.random() - 0.5) * 5; // Fluctuation modérée autour du pic diastolique
            const systolic = currentSystolic + systolicFluctuation; // Pression systolique
            const diastolic = currentDiastolic + diastolicFluctuation; // Pression diastolique

            // Décrémenter la durée restante du pic
            peakDuration -= 0.1; // Étant donné que cette fonction est appelée toutes les 100 ms (0.1 s)

            return {         systolic: Math.min(Math.max(systolic, 90), 200), diastolic: Math.min(Math.max(diastolic, 60), 120) };
        } else {
            // Pas de pic actif, générer normalement
            const systolicFluctuation = (Math.random() - 0.5) * 10; // Fluctuation modérée pour systolique
            const diastolicFluctuation = (Math.random() - 0.5) * 5; // Fluctuation modérée pour diastolique

            // Simuler des pics de stress : augmentation rapide de la pression
            if (Math.random() > 0.95) { // Pic de stress, très rare (5%)
                const stressSpike = Math.random() * 40; // Valeur de pic pour la systolique

                // La diastolique suit également le pic, mais avec une augmentation proportionnellement moindre
                const diastolicSpike = stressSpike * 0.5; // La diastolique augmente, mais de façon moins importante que la systolique

                currentSystolic = baseSystolic + systolicFluctuation + stressSpike; // Mémoriser la valeur du pic pour la systolique
                currentDiastolic = baseDiastolic + diastolicFluctuation + diastolicSpike; // Mémoriser la valeur du pic pour la diastolique

                peakDuration = Math.random() * 3 + 1; // Durée de 3 à 8 secondes
            } else {
                currentSystolic = baseSystolic + systolicFluctuation; // Pas de pic, juste fluctuation normale pour la systolique
                currentDiastolic = baseDiastolic + diastolicFluctuation; // Pas de pic, juste fluctuation normale pour la diastolique
            }

            // Ajustement pour garder les valeurs dans des limites physiologiques
            const adjustedSystolic = Math.min(Math.max(currentSystolic, 90), 200); // Limites pour systolique
            const adjustedDiastolic = Math.min(Math.max(currentDiastolic, 60), 120); // Limites pour diastolique

            return { systolic: adjustedSystolic, diastolic: adjustedDiastolic };
        }
    }










    // Fonction pour classifier l'état de la tension artérielle
    function classifyBloodPressure(systolic, diastolic) {
        if (systolic > 180 || diastolic > 120) {
            return 'Hypertensive Crise (Urgence Médicale)';
        } else if (systolic >= 140 || diastolic >= 90) {
            return 'Hypertension Stade 2';
        } else if (systolic >= 130 || diastolic >= 80) {
            return 'Hypertension Stade 1';
        } else if (systolic >= 120 && diastolic < 80) {
            return 'Pré-Hypertension (Tension Élevée)';
        } else {
            return 'Normale';
        }
    }

    // Initialisation du graphique avec Plotly
    Plotly.newPlot('graph', [{
        x: xData,
        y: yData.map(bp => bp.systolic), // Systolique
        mode: 'lines',
        name: 'Pression Systolique (mmHg)',
        line: { color: 'red' }
    }, {
        x: xData,
        y: yData.map(bp => bp.diastolic), // Diastolique
        mode: 'lines',
        name: 'Pression Diastolique (mmHg)',
        line: { color: 'blue' }
    }], {
        title: {
            text: 'Pression Artérielle en Temps Réel',
            font: {
                size: 25
            },
        },
        xaxis: { title: 'Temps (s)' },
        yaxis: { title: 'Pression (mmHg)', range: [50, 200] }, // Plage de valeurs réalistes
        showlegend: true, // Afficher la légende
        legend: {
            orientation: 'v', // Orientation horizontale
            yanchor: 'bottom', // Ancrage en bas
            y: 0.88, // Position verticale (au-dessus du graphique)
            xanchor: 'center', // Ancrage au centre
            x: 0.5 // Position horizontale (au centre)
        }
    });

    // Fonction pour démarrer la simulation
    function startSimulation() {
        if (intervalID) return;  // Si l'animation tourne déjà, ne rien faire

        startTime = Date.now();  // Temps de départ
        intervalID = setInterval(() => {
            let elapsedTime = (Date.now() - startTime) / 1000;  // Temps écoulé en secondes
            let bloodPressure = generateBloodPressure(elapsedTime);  // Générer la pression artérielle

            // Ajouter les nouvelles données
            xData.push(elapsedTime);
            yData.push(bloodPressure);

            // Mettre à jour le graphique
            Plotly.update('graph', {
                x: [xData, xData],
                y: [yData.map(bp => bp.systolic), yData.map(bp => bp.diastolic)]
            });

            // Classifier l'état actuel de la tension artérielle
            const classification = classifyBloodPressure(bloodPressure.systolic, bloodPressure.diastolic);

            // Afficher l'état sous le graphique
            document.getElementById('classification').innerText = `État de la Tension : ${classification}`;

            // Limiter l'affichage à 20 secondes de données visibles
            if (elapsedTime > 20) {
                xData.shift();  // Retirer les anciennes valeurs
                yData.shift();
            }
        }, 100);  // Mise à jour toutes les 100 ms
    }

    // Ajouter un écouteur d'événements pour le bouton Start
    document.getElementById('startButton').addEventListener('click', startSimulation);
</script>
<script src="/game.js"></script>
